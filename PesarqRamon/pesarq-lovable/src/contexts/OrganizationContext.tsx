
import React, { createContext, useContext, useState, useEffect } from 'react';
import { useOrganizations, Organization } from '@/hooks/useOrganizations';
import { supabase } from '@/integrations/supabase/client';

interface OrganizationContextType {
  currentOrganization: Organization | null;
  setCurrentOrganization: (org: Organization) => void;
  availableOrganizations: Organization[];
  canAccessMultipleOrganizations: boolean;
  loading: boolean;
  isAdmin: boolean;
}

const OrganizationContext = createContext<OrganizationContextType | undefined>(undefined);

export function OrganizationProvider({ children }: { children: React.ReactNode }) {
  const { organizations, loading: orgsLoading } = useOrganizations();
  const [currentOrganization, setCurrentOrganizationState] = useState<Organization | null>(null);
  const [initialized, setInitialized] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [userProfile, setUserProfile] = useState<any>(null);
  const [userAccessibleOrgs, setUserAccessibleOrgs] = useState<string[]>([]);

  console.log('üèõÔ∏è OrganizationContext - Estado atual:', {
    totalOrganizations: organizations.length,
    userProfile,
    userAccessibleOrgs,
    isAdmin,
    loading: orgsLoading || !initialized,
    currentOrganization: currentOrganization?.name
  });

  // Buscar organiza√ß√µes acess√≠veis para o usu√°rio atual
  const fetchUserAccessibleOrganizations = async (userId: string, userRole: string) => {
    try {
      console.log('üîç Buscando organiza√ß√µes acess√≠veis para usu√°rio:', { userId, userRole });

      // Se √© admin UnB, pode acessar todas
      if (userRole === 'unb_admin') {
        console.log('üëë Usu√°rio √© admin UnB - acesso a todas as organiza√ß√µes');
        return organizations.map(org => org.id);
      }

      // Para pesquisadores UnB, buscar v√≠nculos organizacionais
      if (userRole === 'unb_researcher') {
        const { data: links, error } = await supabase
          .from('researcher_organization_links')
          .select('organization_id')
          .eq('researcher_id', userId);

        if (error) {
          console.error('‚ùå Erro ao buscar v√≠nculos:', error);
          return [];
        }

        const linkedOrgIds = links?.map(link => link.organization_id) || [];
        console.log('üîó Organiza√ß√µes vinculadas encontradas:', linkedOrgIds);
        return linkedOrgIds;
      }

      // Para usu√°rios parceiros, usar apenas a organiza√ß√£o do perfil
      if (userProfile?.organization_id) {
        console.log('üè¢ Usu√°rio parceiro - organiza√ß√£o do perfil:', userProfile.organization_id);
        return [userProfile.organization_id];
      }

      console.log('‚ö†Ô∏è Nenhuma organiza√ß√£o acess√≠vel encontrada');
      return [];
    } catch (error) {
      console.error('üí• Erro ao buscar organiza√ß√µes acess√≠veis:', error);
      return [];
    }
  };

  // Calcular organiza√ß√µes dispon√≠veis baseado no perfil do usu√°rio
  const getAvailableOrganizations = () => {
    // Se ainda est√° carregando ou n√£o tem perfil, retornar array vazio
    if (orgsLoading || !userProfile || !initialized) {
      return [];
    }

    // Se √© admin UnB, pode ver todas as organiza√ß√µes (ativas e inativas)
    if (isAdmin) {
      console.log('üëë Admin UnB - todas as organiza√ß√µes dispon√≠veis:', organizations.length);
      return organizations;
    }

    // Para outros usu√°rios, filtrar apenas organiza√ß√µes ativas e acess√≠veis
    const accessibleActiveOrgs = organizations.filter(org => 
      org.status === 'ativa' && userAccessibleOrgs.includes(org.id)
    );

    console.log('üìã Organiza√ß√µes dispon√≠veis para usu√°rio:', {
      total: organizations.length,
      ativas: organizations.filter(org => org.status === 'ativa').length,
      acessiveis: userAccessibleOrgs.length,
      resultado: accessibleActiveOrgs.length
    });

    return accessibleActiveOrgs;
  };

  const availableOrganizations = getAvailableOrganizations();

  // Verificar se usu√°rio √© admin UnB
  const checkAdminStatus = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      console.log('üîç Verificando status do usu√°rio:', user?.email);
      
      if (!user) {
        console.log('‚ùå Usu√°rio n√£o autenticado');
        setIsAdmin(false);
        return false;
      }

      // Verificar se √© admin UnB pelo email
      const isUnbAdmin = user.email === 'carloshunb@gmail.com';
      console.log('üëë √â admin UnB?', isUnbAdmin, 'Email:', user.email);
      
      if (isUnbAdmin) {
        setIsAdmin(true);
        return true;
      }

      // Verificar pelo perfil na base de dados
      const { data: profile, error } = await supabase
        .from('user_profiles')
        .select('role, is_active')
        .eq('id', user.id)
        .maybeSingle();
        
      console.log('üë§ Perfil do usu√°rio:', { profile, error });
      
      if (profile && profile.role === 'unb_admin' && profile.is_active) {
        console.log('‚úÖ Usu√°rio confirmado como admin UnB via perfil');
        setIsAdmin(true);
        return true;
      }
      
      setIsAdmin(false);
      return false;
    } catch (error) {
      console.error('‚ùå Erro ao verificar status de admin:', error);
      setIsAdmin(false);
      return false;
    }
  };

  // Garantir que o usu√°rio tenha um perfil v√°lido
  const ensureUserProfile = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      console.log('üîç OrganizationContext - Usu√°rio atual:', user?.email);
      
      if (!user) {
        console.log('‚ùå Usu√°rio n√£o autenticado');
        return null;
      }

      // Verificar se o usu√°rio j√° tem um perfil
      const { data: existingProfile, error: profileError } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('id', user.id)
        .maybeSingle();
        
      console.log('üë§ OrganizationContext - Perfil existente:', {
        profile: existingProfile,
        error: profileError,
        hasProfile: !!existingProfile
      });
      
      if (existingProfile) {
        setUserProfile(existingProfile);
        
        // Buscar organiza√ß√µes acess√≠veis para este usu√°rio
        const accessibleOrgIds = await fetchUserAccessibleOrganizations(
          existingProfile.id, 
          existingProfile.role
        );
        setUserAccessibleOrgs(accessibleOrgIds);
        
        // Verificar se √© admin UnB
        const userIsAdmin = existingProfile.role === 'unb_admin' || user.email === 'carloshunb@gmail.com';
        setIsAdmin(userIsAdmin);
        
        console.log('üîë Usu√°rio √© admin UnB:', userIsAdmin);
        return existingProfile;
      }

      // Se n√£o tem perfil, criar um
      const newUserIsAdmin = user.email === 'carloshunb@gmail.com';
      console.log('üÜï Criando perfil para usu√°rio:', {
        userId: user.id,
        email: user.email,
        isAdmin: newUserIsAdmin
      });

      const { data: newProfile, error: insertError } = await supabase
        .from('user_profiles')
        .insert([{
          id: user.id,
          name: user.email?.split('@')[0] || 'Usu√°rio',
          email: user.email || '',
          role: newUserIsAdmin ? 'unb_admin' : 'partner_user',
          organization_id: newUserIsAdmin ? null : null, // Ser√° definido depois
          is_active: true
        }])
        .select()
        .single();
        
      if (insertError) {
        console.error('‚ùå Erro ao criar perfil:', insertError);
        return null;
      } else {
        console.log('‚úÖ Perfil criado com sucesso:', newProfile);
        setUserProfile(newProfile);
        setIsAdmin(newUserIsAdmin);
        
        // Para novos usu√°rios n√£o-admin, buscar organiza√ß√µes acess√≠veis
        if (!newUserIsAdmin) {
          const accessibleOrgIds = await fetchUserAccessibleOrganizations(
            newProfile.id, 
            newProfile.role
          );
          setUserAccessibleOrgs(accessibleOrgIds);
        }
        
        return newProfile;
      }
    } catch (error) {
      console.error('üí• Erro ao garantir perfil do usu√°rio:', error);
      return null;
    }
  };

  // Inicializar quando as organiza√ß√µes carregarem
  useEffect(() => {
    const initializeContext = async () => {
      if (!orgsLoading && !initialized && organizations.length >= 0) {
        console.log('üîÑ OrganizationContext: Inicializando com organiza√ß√µes:', organizations.length);
        
        // Primeiro verificar status de admin
        const isUserAdmin = await checkAdminStatus();
        
        // Garantir que o usu√°rio tenha um perfil v√°lido
        const profile = await ensureUserProfile();
        
        if (profile || isUserAdmin) {
          console.log('üìä Configurando organiza√ß√µes para:', { 
            isAdmin: isUserAdmin, 
            totalOrgs: organizations.length,
            profileOrgId: profile?.organization_id,
            profileRole: profile?.role
          });
          
          // Aguardar um pouco para que userAccessibleOrgs seja definido
          setTimeout(() => {
            const availableOrgs = getAvailableOrganizations();
            
            console.log('üéØ Organiza√ß√µes dispon√≠veis ap√≥s timeout:', {
              availableCount: availableOrgs.length,
              userAccessibleOrgs: userAccessibleOrgs.length,
              profileOrgId: profile?.organization_id
            });

            // Se √© admin UnB, usar primeira organiza√ß√£o como padr√£o
            if (isUserAdmin && organizations.length > 0) {
              console.log('üëë Admin UnB detectado - definindo primeira organiza√ß√£o como padr√£o');
              setCurrentOrganizationState(organizations[0]);
            } 
            // Para usu√°rios parceiros, PRIORIZAR a organiza√ß√£o do perfil
            else if (profile?.organization_id && !isUserAdmin) {
              console.log('üîç Buscando organiza√ß√£o do perfil:', profile.organization_id);
              
              // Buscar a organiza√ß√£o espec√≠fica do perfil
              const userOrg = organizations.find(org => org.id === profile.organization_id);
              
              if (userOrg && userOrg.status === 'ativa') {
                console.log('üéØ Organiza√ß√£o do perfil encontrada e ativa:', userOrg.name);
                setCurrentOrganizationState(userOrg);
              } else {
                console.log('‚ö†Ô∏è Organiza√ß√£o do perfil n√£o encontrada ou inativa, usando primeira dispon√≠vel');
                if (availableOrgs.length > 0) {
                  setCurrentOrganizationState(availableOrgs[0]);
                }
              }
            } 
            // Fallback para primeira organiza√ß√£o dispon√≠vel
            else if (availableOrgs.length > 0) {
              console.log('üîß Usando primeira organiza√ß√£o dispon√≠vel como fallback');
              setCurrentOrganizationState(availableOrgs[0]);
            } else {
              console.log('‚ùå Nenhuma organiza√ß√£o dispon√≠vel encontrada');
            }
          }, 300); // Aumentei o timeout para dar mais tempo
        }
        
        setInitialized(true);
        console.log('‚úÖ OrganizationContext: Inicializado');
      }
    };

    initializeContext();
  }, [orgsLoading, organizations.length, initialized]);

  const setCurrentOrganization = async (org: Organization) => {
    console.log('üè¢ OrganizationContext: Definindo organiza√ß√£o:', org.name);
    setCurrentOrganizationState(org);
    localStorage.setItem('selectedOrganizationId', org.id);
    
    // Para usu√°rios n√£o-admin, atualizar o perfil com a nova organiza√ß√£o selecionada
    if (!isAdmin && userProfile) {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          const { error } = await supabase
            .from('user_profiles')
            .update({ 
              organization_id: org.id,
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);
            
          if (error) {
            console.error('‚ùå Erro ao atualizar organiza√ß√£o do usu√°rio:', error);
          } else {
            console.log('‚úÖ Organiza√ß√£o do usu√°rio atualizada:', org.name);
            // Atualizar o estado local do perfil
            setUserProfile(prev => ({ ...prev, organization_id: org.id }));
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao atualizar perfil do usu√°rio:', error);
      }
    }
  };

  const contextValue = {
    currentOrganization,
    setCurrentOrganization,
    availableOrganizations,
    canAccessMultipleOrganizations: isAdmin || availableOrganizations.length > 1,
    loading: orgsLoading || !initialized,
    isAdmin
  };

  console.log('üìä OrganizationContext - Valor final do contexto:', {
    hasCurrentOrganization: !!contextValue.currentOrganization,
    currentOrgName: contextValue.currentOrganization?.name,
    availableCount: contextValue.availableOrganizations.length,
    canAccessMultiple: contextValue.canAccessMultipleOrganizations,
    loading: contextValue.loading,
    isAdmin: contextValue.isAdmin,
    userRole: userProfile?.role,
    profileOrgId: userProfile?.organization_id
  });

  return (
    <OrganizationContext.Provider value={contextValue}>
      {children}
    </OrganizationContext.Provider>
  );
}

export function useOrganizationContext() {
  const context = useContext(OrganizationContext);
  if (context === undefined) {
    throw new Error('useOrganizationContext must be used within an OrganizationProvider');
  }
  return context;
}
